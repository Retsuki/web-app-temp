# 多言語対応実装設計書

## 概要
Next.js公式のInternationalization機能を使用して、日本語と英語の多言語対応を実装します。外部ライブラリに依存せず、Next.jsの標準機能のみで実現します。

## 対応言語
- 日本語 (ja) - デフォルト
- 英語 (en)

## アーキテクチャ

### 1. ディレクトリ構造

```
app/
├── [lang]/                        # 動的ロケールセグメント
│   ├── (auth)/                    # 認証グループ
│   │   ├── signin/
│   │   │   └── page.tsx
│   │   └── signup/
│   │       └── page.tsx
│   ├── (main)/                    # メインアプリグループ
│   │   └── dashboard/
│   │       └── page.tsx
│   ├── layout.tsx                 # ルートレイアウト
│   ├── page.tsx                   # ホームページ
│   └── dictionaries.ts            # 辞書ローダー
├── auth/                          # [lang]外のルート
│   └── callback/
│       └── route.ts               # OAuth callback
├── dictionaries/                  # 翻訳ファイル
│   ├── ja.json
│   └── en.json
└── api/                          # APIルート（言語不要）
```

### 2. ルーティング戦略

#### URLパターン
- `/ja` - 日本語ホームページ
- `/en` - 英語ホームページ
- `/ja/signin` - 日本語サインイン
- `/en/dashboard` - 英語ダッシュボード
- `/auth/callback` - 言語共通のOAuthコールバック

#### ミドルウェアによる処理
1. ルートアクセス時 (`/`) にブラウザ言語を検出
2. 適切なロケールへリダイレクト (`/ja` or `/en`)
3. 認証チェックと組み合わせて動作

### 3. 実装コンポーネント

#### 3.1 ミドルウェア (`middleware.ts`)
```typescript
// 主な責務：
- ロケール検出（Accept-Languageヘッダー）
- ロケールなしURLへのリダイレクト
- 認証チェック（既存機能との統合）
```

#### 3.2 辞書システム
```typescript
// dictionaries/ja.json
{
  "common": {
    "signIn": "サインイン",
    "signUp": "サインアップ",
    "dashboard": "ダッシュボード"
  },
  "auth": {
    "email": "メールアドレス",
    "password": "パスワード",
    "loginWithGoogle": "Googleでログイン"
  }
}

// app/[lang]/dictionaries.ts
- 動的インポートで必要な言語のみロード
- 型安全な辞書アクセス
```

#### 3.3 翻訳フック
```typescript
// Server Component用
const dict = await getDictionary(lang);

// Client Component用（必要に応じて）
const dict = useDictionary(lang);
```

### 4. 移行手順

#### Phase 1: 基盤整備
1. 必要なパッケージのインストール
   - `negotiator`: ブラウザ言語検出
   - `@formatjs/intl-localematcher`: ロケールマッチング

2. ミドルウェアの実装
   - ロケール検出ロジック
   - リダイレクト処理
   - 既存の認証処理との統合

#### Phase 2: ディレクトリ構造の変更
1. `app/[lang]/`ディレクトリの作成
2. 既存ページの移動
   - `(auth)/*` → `[lang]/(auth)/*`
   - `(main)/*` → `[lang]/(main)/*`
3. レイアウトファイルの調整

#### Phase 3: 翻訳システムの実装
1. 辞書ファイルの作成
2. 辞書ローダーの実装
3. 各ページでの翻訳適用

#### Phase 4: UI要素の実装
1. 言語切り替えコンポーネント
2. ナビゲーションリンクの更新
3. フォームバリデーションメッセージの翻訳

### 5. 技術的な考慮事項

#### パフォーマンス
- Server Componentsで翻訳ファイルをロード（クライアントバンドルに含まれない）
- 動的インポートで必要な言語のみロード
- 静的生成可能（`generateStaticParams`使用）

#### SEO対策
- `lang`属性の適切な設定
- `hreflang`タグの実装（将来的に）
- URLパスにロケールを含める

#### 型安全性
- 辞書の型定義を生成
- パスパラメータの型定義
- 翻訳キーの自動補完

### 6. 実装上の注意点

#### 既存機能との統合
- Supabase認証は言語に依存しない
- APIルートは`[lang]`セグメントの外に配置
- OAuthコールバックは言語共通

#### エラーハンドリング
- 不正なロケールへのアクセス → デフォルト言語へリダイレクト
- 翻訳キーが見つからない → フォールバック表示

#### 開発体験
- 翻訳キーの管理方法を統一
- コンポーネントごとに翻訳を整理
- TypeScriptの型サポートを最大限活用

### 7. 将来の拡張性

#### 追加可能な機能
- 言語の追加（中国語、韓国語など）
- 地域別の設定（en-US, en-GB）
- 翻訳管理システムの導入
- A/Bテスト用の翻訳バリエーション

#### 段階的な改善
1. 基本的な翻訳機能
2. 日付・数値のフォーマット
3. 複数形対応
4. コンテキストベースの翻訳

## まとめ
この設計により、Next.jsの標準機能を活用した、シンプルで拡張性の高い多言語対応を実現します。外部ライブラリへの依存を最小限に抑えながら、型安全性とパフォーマンスを両立させます。