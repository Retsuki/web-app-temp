---
title: 課金機能（Stripe）仕様・利用方法
description: プラン一覧、チェックアウト、サブスクリプション管理、Webhook、環境変数、確認手順
---

# 概要

本プロジェクトの課金機能は Stripe を用いたサブスクリプション課金です。API は Hono（OpenAPI 対応）で提供し、フロントは Next.js から OpenAPI 生成クライアント（react-query）で呼び出します。

- 提供機能
  - プラン一覧取得（free/indie/pro）
  - Stripe Checkout による購入フロー開始
  - サブスクリプション状態取得・更新・解約
  - 決済履歴取得
  - Stripe Webhook によるサーバー側更新
- Swagger UI（開発時）: <http://localhost:8080/api/v1/ui>

# プラン構成

- free（参考用・課金対象外）
- indie（月/年）
- pro（月/年）

API からは価格や機能上限、Price ID が返却されます（free は返しません）。Price ID は環境変数から取得します。

# ユーザーフロー（UI）

1. 価格ページでプラン・請求サイクルを選択: `web/src/app/[lang]/(main)/pricing/pricing-content.tsx`
2. ログイン済みなら「プラン選択」→ API `POST /api/v1/billing/checkout` を呼び出し、Stripe Checkout の `checkoutUrl` にリダイレクト
3. Stripe で決済完了
4. Webhook `POST /api/v1/stripe/webhook` が Stripe から呼ばれ、DB のサブスクリプション/決済履歴を更新
5. アカウント画面で状態を確認: `web/src/app/[lang]/(main)/account/billing-status.tsx`

# フロントエンドからの利用

OpenAPI 生成クライアント（orval）を使用します。

- プラン取得: `useGetPlans`（web/src/lib/api/generated/billing/billing.ts）
- チェックアウト作成: `useCreateCheckout`
- サブスクリプション取得: `useGetSubscription`

例（チェックアウト開始）: `pricing-content.tsx` 内

```ts
createCheckout.mutate(
  { data: { planId, billingCycle, locale: 'ja' } },
  {
    onSuccess: (data) => {
      if (data?.checkoutUrl) window.location.href = data.checkoutUrl
    },
  }
)
```

# API リファレンス（主要）

ベースパス: `/api/v1`（開発サーバー既定ポート: 8080）

注意: 認証が必要なエンドポイントは `Authorization: Bearer <token>` を付与してください。

## プラン一覧

- GET `/plans`
- 認証: 不要
- 例

```bash
curl http://localhost:8080/api/v1/plans
```

レスポンス（抜粋）

```json
{
  "plans": [
    {
      "id": "indie",
      "name": "Indie",
      "description": "個人開発者や小規模プロジェクト向け",
      "monthlyPrice": 1000,
      "yearlyPrice": 10000,
      "features": {
        "projectLimit": 5,
        "apiCallsPerMonth": 10000,
        "teamMembers": 3,
        "storage": 10,
        "support": "email"
      }
    }
  ]
}
```

## チェックアウト作成（Stripe Checkout）

- POST `/billing/checkout`
- 認証: 必要
- Body

```json
{
  "planId": "indie" | "pro",
  "billingCycle": "monthly" | "yearly",
  "locale": "ja" | "en"
}
```

- 例

```bash
curl -X POST http://localhost:8080/api/v1/billing/checkout \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "planId": "indie",
    "billingCycle": "monthly",
    "locale": "ja"
  }'
```

- 成功レスポンス

```json
{
  "checkoutUrl": "https://checkout.stripe.com/c/pay/cs_test_...",
  "sessionId": "cs_test_..."
}
```

この `checkoutUrl` にリダイレクトすると Stripe の購入画面に遷移します。

## サブスクリプション取得

- GET `/billing/subscription`
- 認証: 必要
- 例

```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/v1/billing/subscription
```

- 成功レスポンス（例）

```json
{
  "subscriptionId": "sub_xxx",
  "plan": "indie",
  "status": "active",
  "billingCycle": "monthly",
  "currentPeriodStart": "2025-09-01T00:00:00.000Z",
  "currentPeriodEnd": "2025-10-01T00:00:00.000Z",
  "cancelAt": null,
  "canceledAt": null
}
```

## サブスクリプション更新（プラン/請求サイクル変更）

- PATCH `/billing/subscription`
- 認証: 必要
- Body

```json
{ "planId": "indie" | "pro", "billingCycle": "monthly" | "yearly" }
```

- 例

```bash
curl -X PATCH http://localhost:8080/api/v1/billing/subscription \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{ "planId": "pro", "billingCycle": "yearly" }'
```

- 成功レスポンス（例）

```json
{
  "subscriptionId": "sub_xxx",
  "plan": "pro",
  "billingCycle": "yearly",
  "status": "active",
  "message": "プランをアップグレードしました。差額は日割りで請求されます。"
}
```

## サブスクリプション解約

- DELETE `/billing/subscription`
- 認証: 必要
- Body

```json
{ "immediately": false }
```

- 例

```bash
curl -X DELETE http://localhost:8080/api/v1/billing/subscription \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{ "immediately": false }'
```

- 成功レスポンス（例）

```json
{
  "subscriptionId": "sub_xxx",
  "cancelAt": "2025-10-01T00:00:00.000Z",
  "message": "サブスクリプションは2025/10/01に解約されます。それまではサービスをご利用いただけます。"
}
```

## 決済履歴

- GET `/billing/history?limit=10`
- 認証: 必要
- 例

```bash
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/v1/billing/history?limit=10"
```

- 成功レスポンス（例）

```json
{
  "payments": [
    {
      "paymentId": "pi_...",
      "amount": 1000,
      "currency": "jpy",
      "status": "succeeded",
      "description": "Indie monthly",
      "paidAt": "2025-09-01T00:00:00.000Z",
      "createdAt": "2025-09-01T00:00:00.000Z"
    }
  ],
  "hasMore": false
}
```

# Webhook

- POST `/stripe/webhook`
- ヘッダー: `stripe-signature` 必須
- ボディ: `text/plain`（Stripeのraw body）
- 実装: `api/src/features/stripe-webhook/index.ts`
- 主なイベント
  - `customer.subscription.created/updated/deleted`
  - `invoice.payment_succeeded/failed`

開発確認（Stripe CLI 例）

```bash
stripe listen --forward-to localhost:8080/api/v1/stripe/webhook
```

# 必要な環境変数

API（`api/.env` or `/etc/secrets/.env`）

```
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRICE_ID_INDIE_MONTHLY=price_...
STRIPE_PRICE_ID_INDIE_YEARLY=price_...
STRIPE_PRICE_ID_PRO_MONTHLY=price_...
STRIPE_PRICE_ID_PRO_YEARLY=price_...
```

Web（`web/.env.local`）

```
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

# 開発・確認手順

1. 環境変数を設定（上記参照）
2. 依存サービス（Supabase ローカル等）を起動（必要に応じて）
3. ルートで `npm run dev`（API 8080 / Web 3000）
4. Swagger UI: <http://localhost:8080/api/v1/ui> でエンドポイント確認
5. Web UI: <http://localhost:3000/ja/pricing> から購入フローを確認
6. Webhook: Stripe CLI でイベントを転送して DB 反映を確認

# 既知の注意点

- チェックアウト作成は「既に有効なサブスクリプションがある場合」400 を返します。
- プラン変更はアップグレード即時・ダウングレードは次回更新時反映です（実装上の `proration_behavior` に準拠）。
- Webhook は `text/plain` を受け取り、署名検証を行います。プロキシやゲートウェイ（API Gateway 等）配下に置く場合は raw body が届く設定にしてください。
- 価格は DB の `plan_limits` と環境変数の Price ID に依存します。Price ID 未設定の場合、チェックアウト作成で 400 となります。
